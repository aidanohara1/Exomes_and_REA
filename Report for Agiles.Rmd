---
title: "Report for A Giles"
author: "Aidan O'Hara"
date: "2023-03-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(Rmisc) 
library(dplyr)
library(gmodels)
library(ggplot2)
library(nnet)

# read in
AGiles <- read.csv("AGiles.csv")
AGiles_OG <- read.csv("AGiles_originalOnly.csv")
# original reports are already isolated in Agiles_OG

# AGiles <- read.csv("~/Desktop/ma676_featureengineering_automl-Ashleycc1/AGiles.csv")
# AGiles_OG <- read.csv("~/Desktop/ma676_featureengineering_automl-Ashleycc1/AGiles_originalOnly.csv")

AGiles <- rename(AGiles, 
       abcBuckets = `ABC.REA.buckets`,
       sex = `Sex..reported.at.birth.`,
       age = `Age.Group`,
       indication = `Indication.Diagnostic.Rate`,
       reanalyzed = Reanalyed)

AGiles_OG <- rename(AGiles_OG, 
       abcBuckets = `ABC.REA.buckets`,
       sex = `Sex..reported.at.birth.`,
       age = `Age.Group`,
       indication = `Indication.Diagnostic.Rate`,
       reanalyzed = Reanalyed)



AGiles$`Report.Outcome`[AGiles$`Report.Outcome` == "positive"] <- "Positive"

# factorize report outcome
AGiles_OG <- mutate(AGiles_OG, classification = ifelse(`Report.Outcome`=="Positive",1,
                                                       ifelse(`Report.Outcome`=="Uncertain",0,-1)))
# factorize report outcome
AGiles <- mutate(AGiles, classification = ifelse(`Report.Outcome`=="Positive",1,
                                                       ifelse(`Report.Outcome`=="Uncertain",0,-1)))

# factorize report outcome again
AGiles_OG <- mutate(AGiles_OG, reclassification = ifelse(`Report.Outcome`=="Positive",1,0))
# factorize report outcome again
AGiles <- mutate(AGiles, reclassification = ifelse(`Report.Outcome`=="Negative",0,1))

latestAgilesGG <- group_by(AGiles, `New.study.ID`) %>%
  slice(which.max(as.Date(`Report.Date`, '%M/%Y'))) %>%
  mutate(binReanaz = ifelse(`Original.Latest` != "Original", 1,0))


AGiles <- AGiles %>% mutate(across(c(reanalyzed,
                                     Reclassified,
                                     Original.Latest,
                                     Report.Outcome,
                                     Initiator.of.reanalysis,
                                     Evidence.for.reclassification,
                                     Default.REA.buckets,
                                     abcBuckets,
                                     sex,
                                     classification,
                                     reclassification),
                                   factor))

AGiles_OG <- AGiles_OG %>% mutate(across(c(reanalyzed,
                                           Reclassified,
                                           Original.Latest,
                                           Report.Outcome,
                                           Initiator.of.reanalysis,
                                           Evidence.for.reclassification,
                                           Default.REA.buckets,
                                           abcBuckets,
                                           sex,
                                           classification,
                                           reclassification),
                                         factor))

age_levels <- c("Fetal", "<1", "1-5", "6-10", "11-18", "19-35", "36-50", "51+")

AGiles$age = factor(x = AGiles$age, levels = age_levels, ordered = T)
AGiles_OG$age = factor(x = AGiles_OG$age, levels = age_levels, ordered = T)


# remove repeated observations by keeping only the newest log
latestAgiles <- group_by(AGiles, `New.study.ID`) %>%
  slice(which.max(as.Date(`Report.Date`, '%M/%Y'))) %>%
  mutate(binReanaz = ifelse(`Original.Latest` != "Original", 1,0))

### Making two separate samples for models that talk about reclassification

# one sample will have every reanalysis event, 
justReanaz <- AGiles %>% filter(reanalyzed == 1)
# the other sample will have one reanalysis event, per study id, randomly selected
set.seed(800)

myList <- split(justReanaz, justReanaz$`New.study.ID`)

uniqueReanaz <- data.table::rbindlist(lapply(myList, 
                                             function(x) if(nrow(x) > 1) x[sample(nrow(x), 1), ] else x))


# Sample of 
# REA ABC buckets with confounders of  binary is positive vs is uncertain (negatives removed)
#  cases with reported alterations

posUncertain <- AGiles %>% filter(Reclassified == 1 & classification != -1)

myList2 <- split(posUncertain, posUncertain$`New.study.ID`)

uniqueUncertain <- data.table::rbindlist(lapply(myList2, 
                                             function(x) if(nrow(x) > 1) x[sample(nrow(x), 1), ] else x))

# Just reclassifications

justReclass <- AGiles %>% filter(Reclassified == 1)

myList3 <- split(justReclass, justReclass$`New.study.ID`)
uniqueReclass <- data.table::rbindlist(lapply(myList3, 
                                             function(x) if(nrow(x) > 1) x[sample(nrow(x), 1), ] else x))


# Bust this out if you want to remove Original logs of exomes that have been reanalyzed
#   BUT you want to keep the multiple reanalysis logs

# # tally of id entries per id, helper
# idEntries <- group_by(AGiles, `New.study.ID`) %>%
#   tally()
# 
# # the agiles Ill use for analysis, 
# # most important note is the ommision of Orgianal reports about exomes that have been reanalyzed.
# # keeping multiple reanalysis still... There are tradeoffs
# omitAgiles <- inner_join(AGiles, idEntries, by = "New.study.ID") %>%
#   filter(!(n>1 & `Original.Latest` == "Original"))



```


```{r reclassificationEDAPlots}
### RECLASSSIFICATION plot ###
reclassMeans <- group_by(latestAgilesGG, abcBuckets) %>%
  dplyr::summarise(meanReclassification = mean(Reclassified),
            uci_perGroup = CI(Reclassified)['lower'],
            lci_perGroup = CI(Reclassified)['upper']) %>%
  arrange(abcBuckets)

reanazMeans <- group_by(latestAgilesGG, abcBuckets) %>%
  dplyr::summarise(meanReanaz = mean(reanalyzed),
                   uci_perGroup = CI(reanalyzed)['lower'],
                   lci_perGroup = CI(reanalyzed)['upper']) %>%
  arrange(abcBuckets)

classMeans <- group_by(latestAgilesGG, abcBuckets) %>%
  dplyr::summarise(meanClassification = mean(classification),
                   uci_perGroup = CI(classification)['lower'],
                   lci_perGroup = CI(classification)['upper']) %>%
  arrange(abcBuckets)

latClassMeans <- group_by(latestAgilesGG, abcBuckets) %>%
  dplyr::summarise(meanClassification = mean(classification),
                   uci_perGroup = CI(classification)['lower'],
                   lci_perGroup = CI(classification)['upper']) %>%
  arrange(abcBuckets)


reclassGG <- ggplot(reclassMeans) +
  geom_bar( aes(x=abcBuckets, y=meanReclassification), stat = "identity", alpha = 0.05) +
  geom_errorbar( aes(x=abcBuckets, ymin=lci_perGroup, ymax=uci_perGroup, color = abcBuckets), alpha=0.9, size=1)+
  coord_flip()+
  theme_dark()

reanazGG <- ggplot(reanazMeans) +
  geom_bar( aes(x=abcBuckets, y=meanReanaz), stat = "identity", alpha = 0.05) +
  geom_errorbar( aes(x=abcBuckets, ymin=lci_perGroup, ymax=uci_perGroup, color = abcBuckets), alpha=0.9, size=1)+
  coord_flip()+
  theme_dark()

classGG <- ggplot(classMeans) +
  geom_bar( aes(x=abcBuckets, y=meanClassification), stat = "identity", alpha = 0.05) +
  geom_errorbar( aes(x=abcBuckets, ymin=lci_perGroup, ymax=uci_perGroup, color = abcBuckets), alpha=0.9, size=1)+
  ggtitle("Cumulative classifications") +
  coord_flip()+
  theme_dark()

latClassGG <- ggplot(latClassMeans) +
  geom_bar( aes(x=abcBuckets, y=meanClassification), stat = "identity", alpha = 0.05) +
  geom_errorbar( aes(x=abcBuckets, ymin=lci_perGroup, ymax=uci_perGroup, color = abcBuckets), alpha=0.9, size=1)+
  ggtitle("Up to Date classifications") +
  coord_flip()+
  theme_dark()

reclassGG
reanazGG
classGG
latClassGG
```

```{r}
# summary tables
newOg <- AGiles_OG %>% group_by(abcBuckets, classification) %>%
  summarise(n = n()) %>%
  group_by(abcBuckets) %>% mutate(prob = n / sum(n))

#View(newOg)

newLatest <- latestAgiles %>% group_by(abcBuckets, classification) %>%
  summarise(n = n()) %>%
  group_by(abcBuckets) %>% mutate(prob = n / sum(n)) 

#View(newLatest)


```



```{r modelexplore1}
# Does the distribution of original exome outcomes differ by REA? #
originals <- AGiles_OG

age_levels <- c("Fetal", "<1", "1-5", "6-10", "11-18", "19-35", "36-50", "51+")

originals <- originals %>% mutate(classFact = as.factor(classification),
                                  abcFact = as.factor(abcBuckets),
                                  sexFact = as.factor(sex),
                                  ageFact = as.factor(age))

ogClassification <- multinom(data = originals, 
                             formula = classFact ~ abcFact + age + sex) # Angwer


test <- predict(ogClassification, data = originals, type = "prob")
ogTrain <- data.frame(abcFact = unique(originals$abcFact))

test2 <- predict(ogClassification, originals[!duplicated(originals),])

uniqueCombs <- originals[!duplicated(originals),] %>% mutate(
  modelPred = test2)

# Problem, the model is not making any kind of accurate prediction
```

```{r modelexplore2}

classModel <- glm(data = originals,
                  formula = reclassification ~ abcFact + sexFact + ageFact, family = "binomial")


```


```{r modelexplore3}
oneReclass <- glm(data = latestAgiles, formula = reanalyzed ~ abcBuckets, family = binomial)

oneReclassConfound <- glm(data = latestAgiles, formula = reanalyzed ~ abcBuckets + age + sex + indication,
                          family = binomial)

#make a hit table
# 
# oneReclass2 <- glm(data = latest, formula = Reanalyed ~ A + B + C + A:B + B:C + A:C + A:B:C, family = binomial)
# 
# oneReclass3 <- glm(data = latest, formula = Reanalyed ~ A + B + C, family = binomial)

anova(oneReclass, test = 'Chisq')
anova(oneReclassConfound, test = 'Chisq')

CrossTable(latestAgiles$abcBuckets, latestAgiles$reanalyzed, 
           digits = 2,
           prop.r = T, # row proportion
           prop.c = F, # column proportion
           prop.t = F, # table proportion
           prop.chisq = T, # chi-squared contribution
           expected = T,
           resid = T)


```


REA Default buckets with confounders age/sex/(?indication) by:
```{r gilesmodel1}
# Binary: positive vs is not positive (uncertain and negatives together)
#                 -at original classification
#                 -at current classification

originals <- mutate(originals, classification = ifelse(`Report.Outcome` == "Positive", 1,
                                                         ifelse(`Report.Outcome` == "Uncertain", 0,
                                                                ifelse(`Report.Outcome` == "Negative", 0, NA))))


model1.1 <- glm(data = originals,formula = classification ~ Default.REA.buckets + sex + age + indication,family = binomial)

model1.2 <- glm(data = latestAgiles,formula = classification ~ Default.REA.buckets + sex + age + indication,family = binomial)

```

```{r gilesmodel2}
#Binary: was reanalyzed vs was not reanalyzed
model2 <- glm(data = latestAgiles ,formula = reanalyzed ~ Default.REA.buckets + sex + age + indication,family = binomial)

```

```{r reclass model2}
#Binary: was reclassified vs was not reclassified
reclass21 <- glm(data = justReanaz, 
                formula = Reclassified ~ `Default.REA.buckets` + age + sex + indication,
                family = binomial)

reclass22 <- glm(data = uniqueReanaz, 
                formula = Reclassified ~ `Default.REA.buckets` + age + sex + indication,
                family = binomial)

```

REA ABC buckets with confounders age/sex/(?indication) by:
```{r gilesmodel3}
 # Binary: positive vs is not positive (uncertain and negatives together)
 #                -at original classification
 #                -at current classification

model3.1 <- glm(data = originals, formula = classification ~ abcBuckets + sex + age + indication, family = binomial)

model3.2 <- glm(data = latestAgiles, formula = classification ~ abcBuckets + sex + age + indication, family = binomial)

```

```{r gilesmodel4}
#Binary: was reanalyzed or was not reanalyzed
model4 <- glm(data = latestAgiles, formula = reanalyzed ~ abcBuckets + sex + age + indication, family = binomial)



```

```{r}
#Binary: was reclassified or was not reclassified
reclass41 <- glm(data = justReanaz, 
                formula = Reclassified ~ abcBuckets + age + sex + indication,
                family = binomial)

reclass42 <- glm(data = uniqueReanaz, 
                formula = Reclassified ~ abcBuckets + age + sex + indication,
                family = binomial)

```

```{r gilesmodel5}
#REA ABC buckets with confounders of cases with reported alterations binary is positive vs is uncertain (negatives removed)
outcomes51 <- glm(data = posUncertain, 
                formula = classification ~ abcBuckets + age + sex + indication,
                family = binomial)

outcomes52 <- glm(data = uniqueUncertain, 
                formula = classification ~ abcBuckets + age + sex + indication,
                family = binomial)


```

```{r gilesmodel6}
#REA Default buckets with confounders of cases with reported alterations binary is positive vs is uncertain (negatives removed)
outcomes61 <- glm(data = posUncertain, 
                formula = classification ~ `Default.REA.buckets` + age + sex + indication,
                family = binomial)

outcomes62 <- glm(data = uniqueUncertain, 
                formula = classification ~ `Default.REA.buckets` + age + sex + indication,
                family = binomial)


```
Additional polynomial analysis if there is time. Per our notes, these will need a random intersection score calculation (I think that’s what it was called) to account for the potential multiple reanalysis events in a single individual and randomly select one to be used in this analysis.

REA Default buckets with confounders age/sex/(?indication) by:
```{r gilesmodel7}
# Trigger for reanalysis (Ambry, Provider, Family studies) *This cohort will only include those who have had a reanalysis*


trigger7 <- multinom(data = uniqueReanaz, 
                             formula = `Initiator.of.reanalysis` ~ `Default.REA.buckets` + age + sex + indication)


```

```{r gilesmodel8}
# Evidence used for reclassifications (gene, variant, clinical overlap) *This cohort will only include those who have had a reclassification*
evidence8 <- multinom(data = uniqueReclass, 
                             formula = `Evidence.for.reclassification` ~ `Default.REA.buckets` + age + sex + indication)


```

REA ABC buckets with confounders age/sex/(?indication) by:
```{r gilesmodel9}
# Trigger for reanalysis (Ambry, Provider, Family studies) *This cohort will only include those who have had a reanalysis*

trigger9 <- multinom(data = uniqueReanaz, 
                             formula = `Initiator.of.reanalysis` ~ abcBuckets + age + sex + indication)


```

```{r gilesmodel10}
# Evidence used for reclassifications (gene, variant, clinical overlap) *This cohort will only include those who have had a reclassification*

evidence10 <- multinom(data = uniqueReclass, 
                             formula = `Evidence.for.reclassification` ~ abcBuckets + age + sex + indication)


```

```{r extra}

# Run the likelihood ratio test #
# comparison between a model with or without abcbuckets #


```

```{r extra}



```


